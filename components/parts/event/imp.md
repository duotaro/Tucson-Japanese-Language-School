
# 詳細ページの改修
components/parts/event/detail.js

本文の画像やPDFはnotionのリンクのまま。
これはダウンロードして表示できない？？


## イベント詳細ページの画像・PDF表示について

### 現在の状況分析

#### 画像・PDF処理の現状
イベント詳細ページ（`components/pages/event/detail.js`）とニュース詳細ページ（`components/pages/news/detail.js`）は同じ処理ロジックを使用：

**画像処理（renderBlock内のimageケース）:**
- external画像: NotionのURLをそのまま使用
- internal画像: ローカルパス `/image/download/blog/{page_id}/{block_id}.png` を期待するが、実際にはファイルが存在しない可能性

**PDF/ファイル処理（renderBlock内のfileケース）:**
- external PDF: NotionのURLをそのまま使用
- internal PDF: Notionの `value.file.url` をそのまま使用
- ダウンロードリンクとして表示されるが、ローカルにキャッシュされていない

#### 問題点
1. **Notion URLの制限**
   - 期限付きURL（通常1時間程度で無効）
   - 認証が必要な場合がある
   - 直接参照が制限される場合がある

2. **パフォーマンスの問題**
   - 毎回Notionから取得するため表示が遅い
   - ネットワークエラーで表示できない可能性

3. **SEOの問題**
   - 外部URLのため、検索エンジンがインデックスしにくい

#### 既存システムの活用可能性
- **ImageOptimizer**: 画像最適化とWebP変換システムが既に存在
- **ダウンロードパス**: `public/image/download/` と `public/pdf/download/` の構造が定義済み
- **キャッシュシステム**: 一部のコンテンツでローカルキャッシュが実装されている

### 実装計画（既存コンポーネント活用版）

#### フェーズ1: 既存コンポーネントの活用
1. **既存のダウンロードコンポーネントの確認**
   - `components/download/pdf.js` - PDFダウンロード機能（**そのまま活用**）
   - `components/download/index.js` - 画像最適化機能（参考にして新規作成）

2. **実装方針の決定**
   - PDFダウンロード: 既存の`pdf.js`を使用（完全に機能している）
   - 画像ダウンロード: シンプルなダウンロード用コンポーネントを新規作成
   - 統合コンポーネント: 両機能を統合した`EventDownload`コンポーネントを作成

#### フェーズ2: 画像ダウンロード機能の実装
1. **画像ダウンロードコンポーネントの作成**
   - `components/download/image.js` を新規作成
   - Notion APIから画像URLを取得してダウンロード
   - ローカルに画像を保存（`public/image/download/event/` 配下）
   - シンプルなダウンロードロジックに特化

2. **renderBlock関数の改修**
   - ローカルファイルの存在確認ロジックを追加
   - 存在しない場合はフォールバックとしてNotionのURLを使用

#### フェーズ3: PDFダウンロード機能の統合
1. **既存PDFコンポーネントの活用**
   - `components/download/pdf.js` をそのまま使用
   - イベント用のパス設定を追加（`public/pdf/download/event/`）

2. **renderBlock関数のPDF処理改修**
   - 既存の`savePdfIfNeeded`関数を呼び出し
   - ローカルPDFファイルへのパスを生成

#### フェーズ4: EventDownloadコンポーネントの実装
1. **統合コンポーネントの作成**
   - `components/download/event.js` を作成
   - 画像とPDFの両方のダウンロード処理を統合
   - getStaticPropsから呼び出し可能な設計

2. **ページへの組み込み**
   - `pages/event/[id].js` のgetStaticPropsに組み込み
   - ビルド時にコンテンツをダウンロード

#### フェーズ5: ビルドプロセスへの統合
1. **ビルド時の自動ダウンロード**
   - getStaticProps内で自動実行
   - キャッシュ戦略の実装（更新日時ベース）

2. **開発環境での対応**
   - 開発時は動的にダウンロード
   - キャッシュの有効期限管理

#### フェーズ6: 最適化と改善
1. **画像の最適化**
   - 適切なサイズへのリサイズ
   - 複数解像度の生成（srcset対応）
   - 遅延読み込みの実装

2. **エラーハンドリング**
   - ダウンロード失敗時のリトライ処理
   - フォールバック画像の設定
   - ユーザーへの適切なフィードバック

#### 実装優先順位（更新版）
1. 画像ダウンロードコンポーネントを新規作成
2. 既存PDFコンポーネントの活用準備
3. EventDownload統合コンポーネントの実装
4. ページへの組み込みとテスト
5. 最適化と改善

#### 技術的考慮事項
- **ストレージ容量**: ダウンロードしたファイルの管理
- **更新頻度**: Notionの更新をどう検知するか
- **キャッシュ戦略**: どのタイミングで再ダウンロードするか
- **並列処理**: 複数ファイルの効率的なダウンロード