# 詳細ページの改修
components/parts/event/detail.js

本文の画像やPDFはnotionのリンクのまま。
これはダウンロードして表示できない？？

## 完了した作業 (2025-01-22)

### ニュース詳細ページへの画像・PDFローカル化機能の実装
以下の作業を完了しました：

1. **ニュース用ダウンロードモジュールの作成**
   - `components/download/news.js` を新規作成
   - イベントと同様の画像・PDFダウンロード機能を実装

2. **ニュース詳細ページの改修**
   - `components/pages/news/detail.js` を更新
   - ローカル画像・PDFを優先して表示する機能を追加
   - `renderBlock`関数にnewsIdパラメータを追加
   - 画像とPDFファイルのローカルパスチェック機能を実装

3. **共通コードのリファクタリング**
   - `components/download/contentDownloader.js` を作成
   - 画像・PDFダウンロードロジックを共通化
   - event.js と news.js を共通コードを使用するよう更新
   - 重複コードを削減し、保守性を向上

4. **ビルドプロセスの統合**
   - `pages/[[...slug]].js` にニュースコンテンツのダウンロード処理を追加
   - ビルド時に自動的にニュース記事の画像・PDFをダウンロード
   - イベントと同じ処理フローを実現

### 実装内容の詳細

#### 作成したファイル
- `components/download/news.js` - ニュース用ダウンロードモジュール
- `components/download/contentDownloader.js` - 共通ダウンロードヘルパー

#### 更新したファイル
- `components/pages/news/detail.js` - ローカルコンテンツ対応
- `components/download/event.js` - 共通コードを使用するようリファクタリング
- `pages/[[...slug]].js` - ニュースダウンロード処理を追加

## 現在の状況
フェーズ1およびニュース詳細ページへの適用が完了しました。
イベント・ニュースの両ページで画像・PDFのローカル化が機能しています。

## イベント詳細ページの画像・PDF表示について

### 現在の状況分析

#### 画像・PDF処理の現状
イベント詳細ページ（`components/pages/event/detail.js`）とニュース詳細ページ（`components/pages/news/detail.js`）は同じ処理ロジックを使用：

**画像処理（renderBlock内のimageケース）:**
- external画像: NotionのURLをそのまま使用
- internal画像: ローカルパス `/image/download/blog/{page_id}/{block_id}.png` を期待するが、実際にはファイルが存在しない可能性

**PDF/ファイル処理（renderBlock内のfileケース）:**
- external PDF: NotionのURLをそのまま使用
- internal PDF: Notionの `value.file.url` をそのまま使用
- ダウンロードリンクとして表示されるが、ローカルにキャッシュされていない

#### 問題点
1. **Notion URLの制限**
   - 期限付きURL（通常1時間程度で無効）
   - 認証が必要な場合がある
   - 直接参照が制限される場合がある

2. **パフォーマンスの問題**
   - 毎回Notionから取得するため表示が遅い
   - ネットワークエラーで表示できない可能性

3. **SEOの問題**
   - 外部URLのため、検索エンジンがインデックスしにくい

#### 既存システムの活用可能性
- **ImageOptimizer**: 画像最適化とWebP変換システムが既に存在
- **ダウンロードパス**: `public/image/download/` と `public/pdf/download/` の構造が定義済み
- **キャッシュシステム**: 一部のコンテンツでローカルキャッシュが実装されている

### 実装計画（既存コンポーネント活用版）

#### フェーズ1: 既存コンポーネントの活用
1. **既存のダウンロードコンポーネントの確認**
   - `components/download/pdf.js` - PDFダウンロード機能（**そのまま活用**）
   - `components/download/index.js` - 画像最適化機能（参考にして新規作成）

2. **実装方針の決定**
   - PDFダウンロード: 既存の`pdf.js`を使用（完全に機能している）
   - 画像ダウンロード: シンプルなダウンロード用コンポーネントを新規作成
   - 統合コンポーネント: 両機能を統合した`EventDownload`コンポーネントを作成

#### フェーズ2: 画像ダウンロード機能の実装
1. **画像ダウンロードコンポーネントの作成**
   - `components/download/image.js` を新規作成
   - Notion APIから画像URLを取得してダウンロード
   - ローカルに画像を保存（`public/image/download/event/` 配下）
   - シンプルなダウンロードロジックに特化

2. **renderBlock関数の改修**
   - ローカルファイルの存在確認ロジックを追加
   - 存在しない場合はフォールバックとしてNotionのURLを使用

#### フェーズ3: PDFダウンロード機能の統合
1. **既存PDFコンポーネントの活用**
   - `components/download/pdf.js` をそのまま使用
   - イベント用のパス設定を追加（`public/pdf/download/event/`）

2. **renderBlock関数のPDF処理改修**
   - 既存の`savePdfIfNeeded`関数を呼び出し
   - ローカルPDFファイルへのパスを生成

#### フェーズ4: EventDownloadコンポーネントの実装
1. **統合コンポーネントの作成**
   - `components/download/event.js` を作成
   - 画像とPDFの両方のダウンロード処理を統合
   - getStaticPropsから呼び出し可能な設計

2. **ページへの組み込み**
   - `pages/event/[id].js` のgetStaticPropsに組み込み
   - ビルド時にコンテンツをダウンロード

#### フェーズ5: ビルドプロセスへの統合
1. **ビルド時の自動ダウンロード**
   - getStaticProps内で自動実行
   - キャッシュ戦略の実装（更新日時ベース）

2. **開発環境での対応**
   - 開発時は動的にダウンロード
   - キャッシュの有効期限管理

#### フェーズ6: 最適化と改善
1. **画像の最適化**
   - 適切なサイズへのリサイズ
   - 複数解像度の生成（srcset対応）
   - 遅延読み込みの実装

2. **エラーハンドリング**
   - ダウンロード失敗時のリトライ処理
   - フォールバック画像の設定
   - ユーザーへの適切なフィードバック

#### 実装優先順位（更新版）
1. 画像ダウンロードコンポーネントを新規作成
2. 既存PDFコンポーネントの活用準備
3. EventDownload統合コンポーネントの実装
4. ページへの組み込みとテスト
5. 最適化と改善

#### 技術的考慮事項
- **ストレージ容量**: ダウンロードしたファイルの管理
- **更新頻度**: Notionの更新をどう検知するか
- **キャッシュ戦略**: どのタイミングで再ダウンロードするか
- **並列処理**: 複数ファイルの効率的なダウンロード

---

## 🎉 実装完了報告 (2025-09-24)

### 完了した機能
すべての計画フェーズが完了しました：

#### ✅ フェーズ1-4: 基本実装
- **ニュース詳細ページの画像・PDFローカル化** - 完了
- **共通ダウンロードモジュール** (`contentDownloader.js`) - 完了
- **クライアント・サーバー分離** (`clientPathHelper.js`) - 完了
- **ビルドプロセス統合** - 完了

#### ✅ フェーズ5-6: 高度な機能
- **画像最適化機能** - 完了
  - WebP形式への変換
  - 複数解像度の生成（sm: 480px, md: 800px, lg: 1200px, xl: 1600px）
  - Sharp ライブラリを使用した高品質な画像処理

- **エラーハンドリングの強化** - 完了
  - 指数バックオフを使用したリトライ機能（1s, 2s, 4s）
  - 詳細なエラーログ出力（エラータイプ、メッセージ、タイムスタンプ）
  - タイムアウト設定（画像: 30秒, PDF: 60秒）
  - ファイルサイズの表示と最適化結果の統計表示

### 動作確認結果
- ✅ 開発サーバー正常動作
- ✅ ビルドプロセス正常実行（警告のみ、エラーなし）
- ✅ 画像最適化ログ出力確認

### 実装された技術的改善
- Promise.allSettled() を使用した並列画像処理
- 部分的な最適化失敗でも処理続行
- オリジナル画像のフォールバック保存
- エラー時の一時ファイル自動削除
- 最適化済み画像の存在チェックで重複処理回避

**🏁 この実装計画のすべての作業が完了しました。**