# ビルド時間改善に関する提案書 (Cloudflare Pages版)

## 1. はじめに

現在、当プロジェクトではNotionをヘッドレスCMSとして利用し、Next.jsのSSG（静的サイト生成）でサイトを構築しています。ホスティング環境はCloudflare Pagesです。コンテンツ量の増加に伴い、ビルド時間が長くなってきていることが課題です。

本ドキュメントでは、この課題をCloudflare Pagesの機能を最大限に活用しつつ解決するためのアプローチを提案します。

## 2. 現状の構成における改善案

現在の技術スタック（Next.js + Notion on Cloudflare Pages）を維持したまま実施できる改善案です。

### 案1: On-Demand ISR の導入（推奨度: 高）

Next.jsのISR機能はCloudflare Pagesでも利用可能です。特に、特定のページだけを更新する「On-Demand ISR」が効果的です。

- **概要**:
  - **ビルド**: ビルド時には最小限のページのみを生成し、ビルド時間を大幅に短縮します。
  - **コンテンツ更新**: Notionで記事を更新した際にWebhookを送信し、Cloudflare Functions（Pages Functions）を起動させます。このFunctionがNext.jsの再検証用エンドポイントを叩き、該当ページのみを更新（再生成）します。
  - **初回アクセス**: ビルドされていないページへの初回アクセス時は、サーバーサイドでページが生成され、CloudflareのCDNにキャッシュされます。
- **メリット**:
  - **劇的なビルド時間短縮**: 全ページをビルドする必要がなくなります。
  - **迅速なコンテンツ反映**: コンテンツ更新後、即座にサイトへ反映させることが可能です。
  - **Cloudflareとの親和性**: Pages Functionsを使えば、追加のインフラなしで実現できます。
- **デメリット**:
  - **実装の手間**: Webhookの受信と再検証ロジックの実装が必要です。
  - **初回アクセス時の遅延**: 初回アクセス時のみ、サーバーでのレンダリング待ちが発生します。

### 案2: 画像の最適化とCloudflare Imagesの活用（推奨度: 高）

Cloudflare Pagesでは`next/image`による自動最適化が限定的です。そのため、Cloudflareの提供する画像サービスを活用します。

- **概要**:
  - **静的画像**: ロゴやアイコンなど、更新が全くない画像は従来通り`/public/image`に配置します。
  - **動的画像（推奨）**: Notionから取得する画像は、**Cloudflare Images**にアップロードして配信します。Cloudflare Imagesは、リサイズ、フォーマット変換（AVIF/WebP）、品質調整をURLパラメータで行える強力なサービスです。
- **メリット**:
  - **高速な画像配信**: CloudflareのCDNを通じて最適化された画像が配信され、サイトの表示速度が大幅に向上します。
  - **ビルドへの影響なし**: ビルド時に画像処理を行わないため、ビルドは高速になります。
  - **`next/image`の問題回避**: Cloudflare Pages環境での`next/image`の制約を受けません。
- **デメリット**:
  - **コスト**: Cloudflare Imagesは有料サービスです（ただし、小規模なら無料枠で収まる可能性あり）。
  - **運用フローの変更**: Notionに画像をアップロードした後、それをCloudflare Imagesに同期する仕組み（手動 or スクリプト）が必要になります。

### 案3: ビルド時のデータ取得の最適化（推奨度: 中）

これはホスティング環境に依存しない普遍的な対策です。

- **概要**:
  - 記事一覧ページではタイトルや概要など最小限のデータのみを取得し、記事詳細ページで初めて全文を取得するようにします。
- **メリット**:
  - ビルド時にNotionから取得・処理する総データ量が減り、ビルド時間が短縮されます。
- **デメリット**:
  - すでに実装済みの場合は効果がありません。

## 3. Notionからの移行を視野に入れた提案

### 案4: 専用ヘッドレスCMSへの移行（推奨度: 中）

- **概要**: Contentful, Strapi, Sanity.io, microCMSなど、高速なAPIを持つCMSへ移行します。
- **メリット**:
  - **高速なAPI**: Notionより高速なAPIでビルド時間を短縮できます。
  - **画像配信の統合**: 多くのCMSは画像最適化CDNを内蔵しており、Cloudflare Imagesと同様のメリットをCMSの機能内で享受できます。
  - **豊富な開発者機能**: On-Demand ISRと連携するためのWebhook機能が標準で備わっています。
- **デメリット**:
  - **コスト**: サービス利用料や移行コストが発生します。

### 案5: GitベースのCMSへの移行（推奨度: 低〜中）

- **概要**: Decap CMSやTinaCMSを使い、コンテンツをMarkdownファイルとしてGitリポジトリで管理します。
- **メリット**:
  - **最速のビルド**: 外部APIへのアクセスがなくなり、ビルド時間は理論上最速になります。
  - **Cloudflare Pagesと好相性**: Gitリポジトリと完全に同期するため、Cloudflare Pagesのデプロイフローと非常に相性が良いです。
- **デメリット**:
  - **編集体験の変化**: Notionのようなリッチな編集体験は失われます。

## 4. 提案の評価まとめ (Cloudflare Pages環境)

| 提案 | 導入の容易さ | 効果の大きさ | 運用コスト | Cloudflareとの相性 |
| :--- | :--- | :--- | :--- | :--- |
| **案1: On-Demand ISR** | 中 | **高** | 低 | **高** |
| **案2: Cloudflare Images** | 中 | 高 | 中 | **高** |
| **案3: データ取得最適化** | 高 | 低〜中 | 低 | 中 |
| **案4: 専用CMS移行** | 低 | 高 | 中〜高 | 高 |
| **案5: GitベースCMS移行**| 低 | 高 | 中 | **高** |

## 5. 推奨するアプローチ

Cloudflare Pagesの能力を最大限に引き出すため、以下の段階的なアプローチを推奨します。

1.  **短期的な対策（まず着手すべきこと）**:
    - **`案1: On-Demand ISR`** の導入を最優先で検討します。これがビルド時間の問題を最も直接的に、かつCloudflare Pagesのアーキテクチャに沿った形で解決します。
    - 次に、**`案2: Cloudflare Imagesの活用`** を検討します。画像の表示速度はユーザー体験に直結するため、大きな改善が見込めます。まずは無料枠で試してみるのが良いでしょう。

2.  **中長期的な対策（上記で不十分な場合）**:
    - 短期対策でビルド時間と表示速度が十分に改善されれば、CMSの移行は不要かもしれません。
    - もしNotionの編集体験やAPIの制約自体がボトルネックになっていると感じる場合は、**`案4: 専用ヘッドレスCMSへの移行`** を検討します。その際も、On-Demand ISRやCloudflare Imagesとの連携を前提としてCMSを選定します。