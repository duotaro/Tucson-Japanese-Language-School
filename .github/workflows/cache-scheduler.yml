name: ðŸ“… Scheduled Cache Updates

on:
  # å®šæœŸå®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆUTCæ™‚é–“ï¼‰
  schedule:
    # æ¯Žæ—¥ 9:00 JST (00:00 UTC) - frequentæ›´æ–°
    - cron: '0 0 * * *'
    # æ¯Žé€±æœˆæ›œæ—¥ 10:00 JST (01:00 UTC) - moderateæ›´æ–°  
    - cron: '0 1 * * 1'
    # æ¯Žæœˆ1æ—¥ 11:00 JST (02:00 UTC) - rareæ›´æ–°
    - cron: '0 2 1 * *'
    
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      frequency:
        description: 'æ›´æ–°é »åº¦'
        required: true
        default: 'frequent'
        type: choice
        options:
          - frequent
          - moderate  
          - rare
          - full

env:
  NODE_VERSION: '18'
  YARN_VERSION: '4.2.2'

jobs:
  scheduled-cache-update:
    name: ðŸ”„ Scheduled Cache Update
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãŸã‚ã€tokenä½¿ç”¨
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¦ Setup Yarn
        run: |
          npm install -g yarn@${{ env.YARN_VERSION }}
          yarn --version
          
      - name: ðŸ”„ Cache node_modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('package.json', 'yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
            
      - name: ðŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: ðŸŽ¯ æ›´æ–°é »åº¦ã‚’æ±ºå®š
        id: determine-frequency
        run: |
          if [ "${{ github.event.inputs.frequency }}" != "" ]; then
            # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆ
            FREQUENCY="${{ github.event.inputs.frequency }}"
          else
            # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã®å ´åˆã€cronæ™‚åˆ»ã‹ã‚‰åˆ¤å®š
            HOUR=$(date -u +%H)
            case $HOUR in
              "0")
                FREQUENCY="frequent"
                ;;
              "1")
                FREQUENCY="moderate"
                ;;
              "2")
                FREQUENCY="rare"
                ;;
              *)
                FREQUENCY="frequent"
                ;;
            esac
          fi
          
          echo "frequency=$FREQUENCY" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ æ›´æ–°é »åº¦: $FREQUENCY"
          
      - name: ðŸ”§ æ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
        run: |
          if [ -f "cache/metadata.json" ]; then
            echo "ðŸ“‹ æ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿:"
            cat cache/metadata.json | jq '.lastUpdate, .lastIncrementalUpdate // "æœªå®Ÿè¡Œ"' || echo "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼"
          else
            echo "ðŸ“‹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            mkdir -p cache/notion-data
          fi
          
      - name: ðŸ”„ Notion ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°å®Ÿè¡Œ
        env:
          NEXT_PUBLIC_NOTION_DATABASE_ID: ${{ secrets.NEXT_PUBLIC_NOTION_DATABASE_ID }}
          NEXT_PUBLIC_NOTION_NEWS_DATABASE_ID: ${{ secrets.NEXT_PUBLIC_NOTION_NEWS_DATABASE_ID }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        run: |
          FREQUENCY="${{ steps.determine-frequency.outputs.frequency }}"
          
          echo "ðŸ”„ $FREQUENCY é »åº¦ã§ã®è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹..."
          
          # ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
          if [ -z "$NOTION_TOKEN" ]; then
            echo "âš ï¸ NOTION_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
            echo "ðŸ“ ã“ã®å®Ÿè¡Œã¯ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ç¶™ç¶šã—ã¾ã™ã€‚"
            yarn cache:mock
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ›´æ–°å®Ÿè¡Œ
          case $FREQUENCY in
            "full")
              echo "ðŸ“¦ å…¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°"
              yarn cache:fetch-all
              ;;
            "frequent"|"moderate"|"rare")
              echo "ðŸ“Š $FREQUENCY é »åº¦æ›´æ–°"
              yarn cache:update:$FREQUENCY
              ;;
            *)
              echo "âŒ ä¸æ˜Žãªæ›´æ–°é »åº¦: $FREQUENCY"
              exit 1
              ;;
          esac
          
          echo "updated=true" >> $GITHUB_OUTPUT
          
      - name: ðŸ“Š æ›´æ–°çµæžœç¢ºèª
        id: check-changes
        run: |
          echo "ðŸ“Š æ›´æ–°å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆ:"
          yarn cache:stats
          
          # Gitã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
          git add cache/
          if git diff --cached --quiet; then
            echo "ðŸ“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"
            echo "has-changes=true" >> $GITHUB_OUTPUT
            
            echo "ðŸ“‹ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
            git diff --cached --name-only
          fi
          
      - name: ðŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: steps.check-changes.outputs.has-changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          FREQUENCY="${{ steps.determine-frequency.outputs.frequency }}"
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          git add cache/
          git commit -m "ðŸ”„ è‡ªå‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–° ($FREQUENCY) - $TIMESTAMP
          
          ðŸ“Š æ›´æ–°ã‚µãƒžãƒªãƒ¼:
          - æ›´æ–°é »åº¦: $FREQUENCY
          - å®Ÿè¡Œæ™‚åˆ»: $TIMESTAMP
          - ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
          
          ðŸ¤– Generated with GitHub Actions"
          
      - name: ðŸš€ å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
        if: steps.check-changes.outputs.has-changes == 'true'
        run: |
          git push origin ${{ github.ref_name }}
          echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          
      - name: ðŸ“Š å®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼
        if: always()
        run: |
          FREQUENCY="${{ steps.determine-frequency.outputs.frequency }}"
          HAS_CHANGES="${{ steps.check-changes.outputs.has-changes }}"
          
          echo "## ðŸ“… å®šæœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ æ›´æ–°é »åº¦ | $FREQUENCY |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ å¤‰æ›´æœ‰ç„¡ | $HAS_CHANGES |" >> $GITHUB_STEP_SUMMARY
          echo "| â° å®Ÿè¡Œæ™‚åˆ» | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "cache/metadata.json" ]; then
            CACHE_COUNT=$(cat cache/metadata.json | jq '.databases | keys | length' 2>/dev/null || echo "N/A")
            echo "| ðŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥DBæ•° | $CACHE_COUNT |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ æ¬¡å›žæ›´æ–°äºˆå®š" >> $GITHUB_STEP_SUMMARY
          echo "- **Frequent**: æ¯Žæ—¥ 9:00 JST" >> $GITHUB_STEP_SUMMARY
          echo "- **Moderate**: æ¯Žé€±æœˆæ›œ 10:00 JST" >> $GITHUB_STEP_SUMMARY
          echo "- **Rare**: æ¯Žæœˆ1æ—¥ 11:00 JST" >> $GITHUB_STEP_SUMMARY