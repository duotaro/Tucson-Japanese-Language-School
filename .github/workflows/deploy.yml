name: ðŸš€ Deploy with Cache System

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      cache_strategy:
        description: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°æˆ¦ç•¥'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - frequent
          - moderate
          - rare

env:
  NODE_VERSION: '18'
  YARN_VERSION: '4.2.2'

jobs:
  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã‚¸ãƒ§ãƒ–
  cache-update:
    name: ðŸ“¦ Update Notion Cache
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      cache-updated: ${{ steps.cache-check.outputs.updated }}
      cache-stats: ${{ steps.cache-stats.outputs.stats }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¦ Setup Yarn
        run: |
          npm install -g yarn@${{ env.YARN_VERSION }}
          yarn --version
          
      - name: ðŸ”„ Cache node_modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('package.json', 'yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
            
      - name: ðŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: ðŸ”§ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæº–å‚™
        run: |
          mkdir -p cache/notion-data
          echo "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æº–å‚™ã—ã¾ã—ãŸ"
          
      - name: ðŸ“Š æ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
        id: cache-check
        run: |
          if [ -f "cache/metadata.json" ]; then
            echo "existing-cache=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ æ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
            cat cache/metadata.json | jq '.lastUpdate // "æœªè¨­å®š"' || echo "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼"
          else
            echo "existing-cache=false" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ æ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆåˆå›žå®Ÿè¡Œï¼‰"
          fi
          
      - name: ðŸ”„ Notion ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
        env:
          NEXT_PUBLIC_NOTION_DATABASE_ID: ${{ secrets.NEXT_PUBLIC_NOTION_DATABASE_ID }}
          NEXT_PUBLIC_NOTION_NEWS_DATABASE_ID: ${{ secrets.NEXT_PUBLIC_NOTION_NEWS_DATABASE_ID }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        run: |
          # æˆ¦ç•¥ã‚’æ±ºå®š
          if [ "${{ github.event.inputs.cache_strategy }}" != "" ]; then
            STRATEGY="${{ github.event.inputs.cache_strategy }}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            STRATEGY="full"
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            STRATEGY="moderate"
          else
            STRATEGY="frequent"
          fi
          
          echo "ðŸŽ¯ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°æˆ¦ç•¥: $STRATEGY"
          
          # ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -z "$NOTION_TOKEN" ]; then
            echo "âš ï¸ NOTION_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
            yarn cache:mock
          else
            case $STRATEGY in
              "full")
                echo "ðŸ”„ å…¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã‚’å®Ÿè¡Œ..."
                yarn cache:fetch-all
                ;;
              "frequent"|"moderate"|"rare")
                echo "ðŸ”„ $STRATEGY é »åº¦ã§ã®æ›´æ–°ã‚’å®Ÿè¡Œ..."
                yarn cache:update:$STRATEGY
                ;;
              *)
                echo "âŒ ä¸æ˜Žãªæˆ¦ç•¥: $STRATEGY"
                exit 1
                ;;
            esac
          fi
          
      - name: ðŸ“Š ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆè¡¨ç¤º
        id: cache-stats
        run: |
          echo "ðŸ“Š ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆ:"
          yarn cache:stats || echo "çµ±è¨ˆå–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          
          # çµ±è¨ˆã‚’GitHub Outputã«ä¿å­˜
          if [ -f "cache/metadata.json" ]; then
            STATS=$(cat cache/metadata.json | jq -c '.')
            echo "stats=$STATS" >> $GITHUB_OUTPUT
          fi
          
      - name: ðŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        with:
          name: notion-cache-${{ github.sha }}
          path: |
            cache/
          retention-days: 7
          
  # ãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–
  build-deploy:
    name: ðŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: cache-update
    timeout-minutes: 15
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ“¦ Setup Yarn
        run: |
          npm install -g yarn@${{ env.YARN_VERSION }}
          yarn --version
          
      - name: ðŸ”„ Cache node_modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('package.json', 'yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
            
      - name: ðŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: ðŸ“¥ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          name: notion-cache-${{ github.sha }}
          path: ./
          
      - name: ðŸ” ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
        run: |
          echo "ðŸ“‚ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          find cache/ -name "*.json" | head -5 || echo "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          
          if [ -f "cache/metadata.json" ]; then
            echo "ðŸ“‹ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç¢ºèª:"
            cat cache/metadata.json | jq '.lastUpdate, .databases | keys | length' || echo "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è§£æžã‚¨ãƒ©ãƒ¼"
          fi
          
      - name: ðŸ”§ Environmentè¨­å®š
        run: |
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "ðŸ”§ æœ¬ç•ªç’°å¢ƒç”¨è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ"
          
      - name: ðŸ—ï¸ Next.js ãƒ“ãƒ«ãƒ‰
        run: |
          echo "ðŸ—ï¸ Next.js ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹..."
          echo "ðŸ“Š ãƒ“ãƒ«ãƒ‰å‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ³:"
          ls -la cache/notion-data/ | wc -l && echo "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«æ•°"
          
          # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’åˆ¶é™ã—ã¦ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          yarn build
          
          echo "âœ… ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ"
          
      - name: ðŸ“Š ãƒ“ãƒ«ãƒ‰çµæžœç¢ºèª
        run: |
          echo "ðŸ“Š ãƒ“ãƒ«ãƒ‰çµæžœ:"
          if [ -d "out" ]; then
            echo "âœ… Static export æˆåŠŸ"
            du -sh out/ || echo "ã‚µã‚¤ã‚ºæ¸¬å®šã‚¨ãƒ©ãƒ¼"
            find out/ -name "*.html" | wc -l && echo "HTML ãƒšãƒ¼ã‚¸æ•°"
          else
            echo "âŒ Static export å¤±æ•—"
            exit 1
          fi
          
      - name: ðŸš€ Firebase Deploy (main branch)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "ðŸš€ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹..."
          # Firebase CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å®Ÿè¡Œ
          npm install -g firebase-tools
          # firebase deploy --only hosting
          echo "æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Ÿéš›ã®Firebaseè¨­å®šå¾Œã«æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„"
          
      - name: ðŸš€ Development Deploy (develop branch)
        if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
        run: |
          echo "ðŸ§ª é–‹ç™ºç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹..."
          # é–‹ç™ºç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
          echo "é–‹ç™ºãƒ‡ãƒ—ãƒ­ã‚¤ã¯å®Ÿéš›ã®ç’°å¢ƒè¨­å®šå¾Œã«æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„"
          
      - name: ðŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœãƒ¬ãƒãƒ¼ãƒˆ
        if: always()
        run: |
          echo "## ðŸŽ¯ ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | çŠ¶æ³ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ–ãƒ©ãƒ³ãƒ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚³ãƒŸãƒƒãƒˆ | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–° | ${{ needs.cache-update.outputs.cache-updated || 'æœªå®Ÿè¡Œ' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "cache/metadata.json" ]; then
            CACHE_COUNT=$(cat cache/metadata.json | jq '.databases | keys | length' 2>/dev/null || echo "N/A")
            echo "| ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«æ•° | $CACHE_COUNT |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "out" ]; then
            PAGE_COUNT=$(find out/ -name "*.html" | wc -l)
            echo "| ç”Ÿæˆãƒšãƒ¼ã‚¸æ•° | $PAGE_COUNT |" >> $GITHUB_STEP_SUMMARY
          fi