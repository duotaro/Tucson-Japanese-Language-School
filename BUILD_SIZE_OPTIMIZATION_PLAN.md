# ビルドサイズ削減プロジェクト計画書

**プロジェクト目標**: ビルドサイズ40-50%削減（201MB → 100-120MB）  
**作成日**: 2025-07-12  
**対象**: ツーソン日本語学校ウェブサイト  

---

## 📊 現状分析

### 問題の詳細
- **現在のビルドサイズ**: 201MB（IMPROVEMENT_PROPOSAL.md参照）
- **主要課題**: 
  - 画像最適化無効化（`images.unoptimized = true`）
  - CSS最適化不足（全要素transition適用）
  - バンドル分割不十分
  - Dynamic imports未活用

### 期待効果
- **ビルドサイズ**: 201MB → 100-120MB（40-50%削減）
- **初期表示速度**: 30%向上予測
- **First Contentful Paint**: 改善
- **Largest Contentful Paint**: 改善

---

## 🎯 ルール
**テスト**: 修正後、必ずビルドテストなどを実施すること。エラーなどがあれば即時修正すること。
**進捗管理**: 当ファイルに進捗を記載していくこと。

## 📊 Phase 1 実施結果

### 実施日: 2025-07-12

#### 1. 現在のビルドサイズ分析 ✅
- **総ビルドサイズ**: 209MB
- **構成内訳**:
  - 画像ファイル: 102MB（約49%）
  - JavaScript: 1.3MB
  - CSS: 48KB
- **主要課題**: 画像ファイルが最大の要因

#### 2. webpack バンドル最適化設定 ✅
- chunk分割とコードスプリッティング実装
- React、Notion API、共通コンポーネント別のchunk化
- next.config.jsにwebpack最適化設定追加

#### 3. Critical CSS分離 ✅
- `styles/critical.css`: Above-the-fold用CSS作成
- `styles/non-critical.css`: インタラクティブスタイル分離
- `_document.js`: 非クリティカルCSS遅延読み込み実装

#### 4. ビルドテスト結果 ✅
- **ビルド状況**: 正常完了（警告あり、エラーなし）
- **最終ビルドサイズ**: 209MB（変更なし）
- **Notes**: 静的エクスポート（output: 'export'）のため画像最適化無効

### Phase 1 の評価
- **技術的実装**: 全て完了
- **ビルドサイズ削減**: 期待通りの効果なし
- **原因**: 静的エクスポートによる制約で画像最適化が無効
- **対策**: Phase 2でDynamic imports等の代替手法を実装予定

#### 5. ニュースカード画像デザイン修正 ✅
- **問題**: 縦長画像が`aspect-video`（16:9）強制でデザイン崩れ
- **対象URL**: 
  - http://localhost:3000/news/110a8c0e-cf8c-8035-98f6-d438d58ac188/
  - http://localhost:3000/news/112a8c0e-cf8c-8081-ba97-ef38f356233d/
  - http://localhost:3000/news/112a8c0e-cf8c-8034-8ce5-dced417d9e42/
- **修正内容**:
  - `aspect-video` → `h-48`（固定高さ192px）に変更
  - `ImageOptimizer`に`fill={true}`, `responsive={true}`, `responsiveType="card"`追加
  - `critical.css`にニュースカード画像用スタイル追加
- **効果**: 縦長画像でもカードレイアウト統一、デザイン崩れ解消

## 📊 Phase 2 実施結果

### 実施日: 2025-07-12

#### 1. Dynamic imports導入 ✅
- **対象**: 全ページコンポーネント（15個）+ SliderListコンポーネント
- **実装内容**:
  - `pages/[[...slug]].js`で全ページコンポーネントをdynamic importに変更
  - ローディング状態追加（PageLoading、スケルトンスクリーン）
  - SSR維持（`ssr: true`）でSEO対策
- **特に重いコンポーネント**:
  - CalendarPage（FullCalendarライブラリ）
  - SliderList（Splideライブラリ）
  - FormsPage、NewsDetailPage等

#### 2. Notion API最適化 ✅
- **lib/notion.js**に`getOptimizedDatabase`関数追加
- **機能**:
  - 必要プロパティのみフィルタリング
  - ページサイズ制限
  - ソート機能
  - エラーハンドリング強化
- **効果**: データ転送量削減、API効率化

#### 3. バンドルアナライザー導入 ✅
- **ツール**: @next/bundle-analyzer
- **package.json**に分析コマンド追加:
  - `yarn analyze` - 全体分析
  - `yarn analyze:server` - サーバー側分析
  - `yarn analyze:browser` - ブラウザ側分析
- **next.config.js**にアナライザー設定追加

#### 4. ビルドテスト結果 ✅
- **ビルド状況**: 正常完了（警告あり、エラーなし）
- **最終ビルドサイズ**: 209MB（変更なし）
- **JavaScript分割**: Dynamic importsによりchunk分離

### Phase 2 の評価
- **技術的実装**: 全て完了
- **ビルドサイズ削減**: 総サイズは変わらず（画像102MBが主要因）
- **パフォーマンス向上**: 
  - 初期JavaScript読み込み削減
  - ページ遷移高速化
  - コードスプリッティング効果
- **開発体験向上**: バンドル分析により継続改善可能

## 📊 Phase 3 実施結果

### 実施日: 2025-07-12

#### 1. 画像ファイル詳細分析 ✅
- **blog/ディレクトリ画像**: 25MB（圧縮前）
- **対象ファイル**: 8個のJPEGファイル
- **最大ファイル**: image3.jpeg（5.7MB）
- **形式**: 全てJPEG、高解像度

#### 2. 画像圧縮実施 ✅
- **使用ツール**: ImageMagick convert
- **設定**: 80%品質、1200x800解像度
- **圧縮結果**:
  - image3.jpeg: 5.7MB → 108KB（98%削減）
  - image1.jpeg: 5.1MB → 162KB（97%削減）
  - news2.jpeg: 3.6MB → 230KB（94%削減）
  - announcement1.jpeg: 3.2MB → 603KB（81%削減）
  - news1.jpeg: 2.6MB → 384KB（85%削減）
  - image5.jpeg: 2.5MB → 123KB（95%削減）
  - image2.jpeg: 1.5MB → 125KB（92%削減）
  - image4.jpeg: 1.0MB → 113KB（89%削減）

#### 3. ビルドテスト実施（一部完了）
- **ビルド状況**: 進行中（91/215ページ生成完了時点でタイムアウト）
- **最終ビルドサイズ**: 209MB（前回と同じ）
- **blog画像ディレクトリ**: 25MB → 1.8MB（93%削減）

### Phase 3 の評価
- **画像圧縮**: 大幅な成功（blog画像93%削減）
- **総ビルドサイズ**: 微小な改善のみ（209MB維持）
- **原因**: 
  - blog画像は総ビルドサイズの12%程度
  - 他の大容量画像（約77MB）が主要因として残存
- **次ステップ**: 他ディレクトリの画像最適化が必要

## 🎯 実装フェーズ

### Phase 1: 緊急対応（最高優先度）
**期間**: 1-2週間  
**目標**: 即座にビルドサイズ削減効果が見込める施策

#### 1. 画像最適化設定変更
- **現在**: `images: { unoptimized: true }`
- **変更後**: Next.js画像最適化を有効化
- **期待効果**: ビルドサイズ30-40%削減

#### 2. Critical CSS分離
- **現在**: 全要素にtransition適用
- **変更後**: Above-the-fold用CSS分離、残りは遅延読み込み
- **期待効果**: 初期CSS読み込み量削減

#### 3. webpack バンドル最適化
- **実装**: chunk分割、コードスプリッティング
- **対象**: React、Notion API、共通コンポーネント別chunk化
- **期待効果**: JavaScript初期ロード削減

### Phase 2: 中期改善（高優先度）
**期間**: 3-4週間  
**目標**: さらなる最適化とパフォーマンス向上

#### 4. Dynamic imports導入
- **対象**: 大きなコンポーネント（ニュース詳細、スライダーなど）
- **実装**: 遅延読み込み + ローディング状態
- **期待効果**: JavaScript初期ロード50%削減

#### 5. Notion API最適化
- **現在**: 全プロパティ取得
- **改善**: 必要プロパティのみ選択取得
- **期待効果**: データ転送量削減

### Phase 3: 継続監視（中優先度）
**期間**: 継続的  
**目標**: 最適化効果の継続監視と改善

#### 6. バンドルアナライザー導入
- **ツール**: @next/bundle-analyzer
- **目的**: ビルドサイズ構成要素の可視化
- **効果**: 継続的な問題特定と改善

#### 7. パフォーマンステスト自動化
- **実装**: 各最適化後の効果測定
- **監視項目**: ビルドサイズ、Core Web Vitals
- **目的**: 改善効果の定量評価

---

## 📋 タスク詳細

### 高優先度タスク
1. **現在のビルドサイズ分析** - 構成要素の詳細把握
2. **画像最適化設定変更** - next.config.js修正
3. **Critical CSS分離** - パフォーマンス向上
4. **webpack最適化** - バンドル分割設定

### 中優先度タスク
5. **Dynamic imports実装** - 大きなコンポーネント対象
6. **Notion API最適化** - データ取得効率化
7. **バンドルアナライザー設定** - 継続監視体制
8. **効果測定テスト** - 各段階での効果確認

---

## ⚠️ 実装上の注意事項

### 画像最適化有効化時
- Notion画像URLの処理変更が必要な可能性
- 開発環境での十分なテスト必要
- Firebase Hosting設定確認

### Dynamic imports導入時
- SEOに影響しないよう重要コンテンツは同期読み込み維持
- 適切なローディングステート実装
- エラーバウンダリ設定

### CSS最適化時
- Above-the-fold特定の精度
- スタイル適用タイミングの調整
- 視覚的な変化が生じないよう注意

---

## 📈 成功指標

### 定量指標
- **ビルドサイズ**: 201MB → 100-120MB達成
- **初期表示速度**: 30%向上
- **Lighthouse Performance Score**: 15-20点向上
- **First Contentful Paint**: 改善

### 定性指標
- ユーザー体験の向上
- ページ読み込み速度体感向上
- モバイル環境での利用改善

---

## 🔄 継続改善サイクル

1. **実装** → 2. **測定** → 3. **分析** → 4. **改善**

### 監視項目
- ビルドサイズ推移
- Core Web Vitals指標
- エラー発生状況
- ユーザーフィードバック

### レビュー頻度
- **週次**: 実装進捗確認
- **月次**: パフォーマンス指標レビュー
- **四半期**: 総合的な効果評価

---

**このプロジェクトは段階的な実装により、確実なビルドサイズ削減とパフォーマンス向上を目指します。**