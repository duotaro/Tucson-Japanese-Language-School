# ビルド時間改善のためのNotion APIリクエスト調査結果

## 現状の課題

現在、Next.jsサイトのビルド時間が長くなっており、その主な原因としてビルド時のNotion APIへの過剰なリクエストが考えられる。本ドキュメントは、その原因を特定し、具体的な改善策を提示するための調査結果をまとめたものである。

## 調査概要

ビルドプロセス、特に`getStaticProps`内でのデータ取得処理を分析した結果、`pages/[[...slug]].js`ファイルがサイトのほぼ全てのページの静的生成を担っており、その中で多数のNotionデータベースにアクセスしていることが判明した。

ビルド時に行われているのはNotion APIとの通信であり、レスポンスに含まれるデータサイズよりも**APIリクエストの回数そのもの**がビルド時間を延伸させる主要なボトルネックになっている可能性が極めて高い。

## Notion APIリクエスト一覧と分析

`getStaticProps`内で実行されているNotion APIリクエストをページごとに整理し、ハードコード化による改善効果を評価した。

| ページ (`pageType`) | データベースID | 取得内容 | 更新頻度（推測） | ハードコード優先度 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **Home** | `f2bd94d...` | スライダー画像 | 低 | **高** | トップページ表示速度に直結。内容は頻繁に変わらないはず。 |
| | `1e302ac...` | スポンサーロゴ | 低 | **高** | スポンサーの追加・削除は頻繁ではない。 |
| | `(newsId)` | お知らせ（最新10件） | 高 | 低 | お知らせは更新頻度が高いため、ハードコードに不向き。 |
| | `8d87080...` | スケジュール | 中 | 中 | 年間スケジュールなど。学期ごとに更新される可能性。 |
| | `d4eb382...` | 学校について（概要） | 低 | **高** | 学校の基本情報はほとんど変わらない。 |
| | `d903701...` | 募集（Opportunity） | 中 | 中 | 新しい募集がかかると更新される。 |
| **about/welcome** | `5ceb6b3...` | 理事長挨拶 | 低 | **高** | 理事長の交代時以外は更新されない。 |
| | `02ed913...` | 私たちの思い | 低 | **高** | 学校の理念に関わる部分。 |
| | `15c93b4...` | 沿革 | 低 | **高** | 過去の出来事なので、追記のみ。 |
| **about/mission** | `d4eb382...` | 学校について（再掲） | 低 | **高** | |
| | `f40ad3a...` | 教育理念 | 低 | **高** | |
| | `105a8c0...` | ポリシー（規約） | 低 | **高** | PDFへのリンク。規約改定時のみ更新。 |
| **about/governance**| `10ba8c0...` | 理事・役員 | 低 | **高** | 役員の任期に合わせて更新。 |
| | `10ca8c0...` | 組織図 | 低 | **高** | |
| | `10ca8c0...`` | 組織ポリシー | 低 | **高** | |
| **about/staff** | `122a8c0...` | 役割リスト | 低 | **高** | |
| | `9b85f55...` | スタッフリスト | 中 | 中 | スタッフの入れ替わりで更新。 |
| **about/report** | `11aa8c0...` | 年次報告書 | 低 | **高** | 年に一度の更新。 |
| **program/class** | `11aa8c0...` | クラスカテゴリ | 低 | **高** | |
| | `11aa8c0...` | クラス詳細 | 中 | 中 | 開講クラスの変更時に更新。 |
| **news (一覧)** | `(newsId)` | お知らせ（全件） | 高 | 低 | |
| **news (詳細)** | `(newsId)` | 特定のお知らせ | 高 | 低 | |
| **admissions/forms**| `11ba8c0...` | 資格 | 低 | **高** | |
| | `11ba8c0...` | 料金 | 低 | **高** | |
| | `11ba8c0...` | 家族割引 | 低 | **高** | |
| | `11ca8c0...` | スタッフ割引 | 低 | **高** | |
| | `11ba8c0...` | 登録フォーム | 低 | **高** | |
| **program/calendar**| `8d87080...` | カレンダーファイル | 中 | 中 | |
| **support** | `1e302ac...` | スポンサー（再掲） | 低 | **高** | |
| | `10ca8c0...` | サポートについて | 低 | **高** | |
| | `10ea8c0...` | スポンサーになるには | 低 | **高** | |
| | `10ea8c0...` | 寄付について | 低 | **高** | |
| | `10ca8c0...` | 寄付の方法 | 低 | **高** | |
| **contact/opportunity**| `102a8c0...` | 募集要項 | 中 | 中 | |
| | `d903701...` | General (募集) | 中 | 中 | |

---

## 結論と改善提案

**結論：ビルド時間増大の主要因は、更新頻度の低いコンテンツに対する大量のAPIリクエストである。**

**提案：**
APIリクエストの大部分を占める**更新頻度の低いデータ（上記リストで優先度「高」のもの）をハードコード化する。**

これにより、ビルドプロセスは外部APIへのネットワーク通信からローカルの静的ファイルへのアクセスに置き換わり、ビルド時間の大幅な短縮が見込まれる。

### 推奨される着手順

以下の優先度でハードコード化に着手することを推奨する。

1.  **Homeページ関連のデータ:** スライダー、スポンサー、学校概要など。
2.  **About (学校について) 関連の全データ:** 挨拶、理念、沿革、役員、規約など。
3.  **Admissions (入学案内) 関連のデータ:** 料金、割引、フォーム情報など。

お知らせ（news）やスタッフリスト、募集要項など、更新頻度が「高」または「中」のコンテンツのみをNotionからの取得に残す、ハイブリッドアプローチが最も現実的かつ効果的である。

---

## 📊 **追加調査結果：Notion API vs 画像ファイルの影響比較**

### **調査結論：画像ファイルの影響が圧倒的に大きい**

詳細な調査により、ビルド時間への影響度は以下の通りであることが判明：

- **Notion API処理**: ビルド時間の約5-10%
- **画像ファイル処理**: ビルド時間の約85-90%

### 📈 **具体的なデータ**

#### Notion API使用状況
- **API呼び出し箇所**: 81箇所
- **処理内容**: JSONデータの取得・変換（軽量）
- **処理時間**: 数秒〜数十秒

#### 画像ファイル状況  
- **総画像サイズ**: 117MB
- **最大ファイル**: donations.jpeg (4.9MB)
- **処理内容**: 画像読み込み、WebP変換、複数サイズ生成
- **処理時間**: 数分〜十数分（メモリ8GB制限でタイムアウト）

### 🎯 **修正された推奨事項**

#### ✅ **最優先：画像最適化**
1. **大容量画像の圧縮** 
   - donations.jpeg (4.9MB) → 圧縮
   - sponsor.jpeg (4.7MB) → 圧縮  
   - その他4MB超ファイル → 圧縮
   - **期待効果**: ビルド時間50-70%短縮

2. **画像処理プロセス最適化**
   - **期待効果**: ビルド時間20-30%短縮

#### ⚠️ **二次優先：Notion APIハードコード化**
- **期待効果**: ビルド時間5-10%短縮
- **トレードオフ**: 保守性の大幅悪化
- **推奨**: 画像最適化完了後に必要性を再評価

### 📋 **作業優先度表**

| 優先度 | 施策 | 期待効果 | 工数 | 推奨度 |
|--------|------|----------|------|--------|
| 🔴 最高 | 画像圧縮 | 50-70%短縮 | 1-2日 | **強く推奨** |
| 🟡 中 | 画像処理最適化 | 20-30%短縮 | 3-5日 | 推奨 |
| 🟢 低 | APIハードコード | 5-10%短縮 | 1-2週間 | 条件付き |

**結論：Notion APIのハードコード化よりも、画像ファイル最適化を最優先で実施すべき**
